# ç¬¬4ç«  ç³»ç»Ÿçš„å®ç°ï¼ˆä¸Šï¼‰

## 4.1 ç³»ç»Ÿé¦–é¡µçš„å®ç°

### 4.1.1 é¦–é¡µåŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿé¦–é¡µæ˜¯ç”¨æˆ·ç™»å½•åçœ‹åˆ°çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒå…¥å£ã€‚é¦–é¡µä¸»è¦åŒ…å«ä»¥ä¸‹åŠŸèƒ½æ¨¡å—ï¼š

1. **æ¬¢è¿æ¨ªå¹…**ï¼šæ˜¾ç¤ºç”¨æˆ·åå’Œå®¶åº­ä¿¡æ¯
2. **å®¶åº­ç”»åƒå±•ç¤º**ï¼šæ˜¾ç¤ºå®¶åº­åå¥½çš„å•†å“åˆ†ç±»
3. **æ™ºèƒ½æ¨èåˆ—è¡¨**ï¼šå±•ç¤ºTop 10æ¨èå•†å“
4. **çƒ­é—¨å•†å“å±•ç¤º**ï¼šå±•ç¤ºæœ€å—æ¬¢è¿çš„å•†å“
5. **å¯¼èˆªæ **ï¼šæä¾›å¿«é€Ÿè®¿é—®å„åŠŸèƒ½æ¨¡å—çš„å…¥å£

### 4.1.2 é¦–é¡µè§†å›¾å®ç°

**è§†å›¾å‡½æ•°ä»£ç ï¼ˆviews.pyï¼‰ï¼š**

```python
@login_required
def home(request):
    """é¦–é¡µè§†å›¾å‡½æ•°"""
    user = request.user
    
    # è·å–å®¶åº­ç”»åƒ
    family_profile = None
    if user.family:
        family_profile, _ = FamilyProfile.objects.get_or_create(
            family=user.family
        )
    
    # è·å–æ¨èåˆ—è¡¨
    recommendations = get_user_recommendations(user, top_n=10)
    
    # è·å–è´­ç‰©è½¦ä¿¡æ¯
    cart = None
    cart_count = 0
    if user.family:
        cart, _ = Cart.objects.get_or_create(family=user.family)
        cart_count = cart.get_items_count()
    
    # è·å–çƒ­é—¨å•†å“
    popular_products = Product.objects.annotate(
        behavior_count=Count('behaviors')
    ).order_by('-behavior_count')[:8]
    
    context = {
        'user': user,
        'family_profile': family_profile,
        'recommendations': recommendations,
        'popular_products': popular_products,
        'cart_count': cart_count,
    }
    
    return render(request, 'home.html', context)
```

**å®ç°è¦ç‚¹ï¼š**

1. **ç”¨æˆ·è®¤è¯**ï¼šä½¿ç”¨`@login_required`è£…é¥°å™¨ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
2. **å®¶åº­ç”»åƒè·å–**ï¼šä½¿ç”¨`get_or_create`æ–¹æ³•è·å–æˆ–åˆ›å»ºå®¶åº­ç”»åƒ
3. **æ¨èç”Ÿæˆ**ï¼šè°ƒç”¨æ¨èç®—æ³•ç”Ÿæˆä¸ªæ€§åŒ–æ¨èåˆ—è¡¨
4. **è´­ç‰©è½¦ç»Ÿè®¡**ï¼šè®¡ç®—è´­ç‰©è½¦ä¸­çš„å•†å“æ•°é‡
5. **çƒ­é—¨å•†å“**ï¼šé€šè¿‡ç”¨æˆ·è¡Œä¸ºæ•°é‡ç»Ÿè®¡çƒ­é—¨å•†å“

### 4.1.3 é¦–é¡µæ¨¡æ¿å®ç°

**æ¨¡æ¿ä»£ç ï¼ˆhome.htmlï¼‰ï¼š**

```html
{% extends 'base.html' %}

{% block content %}
<!-- æ¬¢è¿æ¨ªå¹… -->
<div class="welcome-section">
    <h1>ğŸ‘‹ æ¬¢è¿ï¼Œ{{ user.username }}ï¼</h1>
    <p>ä¸ºæ‚¨çš„å®¶åº­æ¨èæœ€åˆé€‚çš„å•†å“</p>
</div>

<!-- å®¶åº­ç”»åƒå±•ç¤º -->
{% if user.family %}
<div class="family-profile-section">
    <h2 class="section-title">ğŸ  å®¶åº­ç”»åƒ - {{ user.family.name }}</h2>
    {% if family_profile.preferred_categories.all %}
    <div class="categories-list">
        {% for category in family_profile.preferred_categories.all %}
        <span class="category-tag">{{ category.name }}</span>
        {% endfor %}
    </div>
    {% else %}
    <p>è¿˜æ²¡æœ‰è®¾ç½®å®¶åº­åå¥½åˆ†ç±»</p>
    {% endif %}
</div>
{% endif %}

<!-- æ¨èåˆ—è¡¨ -->
<div class="recommendations-section">
    <h2 class="section-title">âœ¨ ä¸ºæ‚¨æ¨è</h2>
    {% if recommendations %}
    <div class="products-grid">
        {% for product in recommendations %}
        <div class="product-card">
            <div class="product-image">ğŸ›ï¸</div>
            <div class="product-name">{{ product.name }}</div>
            <div class="product-category">{{ product.category.name }}</div>
            <div class="product-price">Â¥{{ product.price }}</div>
            <div class="product-actions">
                <a href="{% url 'product_detail' product.id %}" 
                   class="btn btn-secondary btn-small">æŸ¥çœ‹</a>
                <a href="{% url 'add_to_cart' product.id %}" 
                   class="btn btn-primary btn-small">åŠ å…¥è´­ç‰©è½¦</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>æš‚æ— æ¨èå•†å“</p>
    </div>
    {% endif %}
</div>

<!-- çƒ­é—¨å•†å“ -->
<div class="recommendations-section">
    <h2 class="section-title">ğŸ”¥ çƒ­é—¨å•†å“</h2>
    <div class="products-grid">
        {% for product in popular_products %}
        <div class="product-card">
            <div class="product-image">ğŸ›ï¸</div>
            <div class="product-name">{{ product.name }}</div>
            <div class="product-category">{{ product.category.name }}</div>
            <div class="product-price">Â¥{{ product.price }}</div>
            <div class="product-actions">
                <a href="{% url 'product_detail' product.id %}" 
                   class="btn btn-secondary btn-small">æŸ¥çœ‹</a>
                <a href="{% url 'add_to_cart' product.id %}" 
                   class="btn btn-primary btn-small">åŠ å…¥è´­ç‰©è½¦</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
```

### 4.1.4 é¦–é¡µæ ·å¼è®¾è®¡

**CSSæ ·å¼è®¾è®¡è¦ç‚¹ï¼š**

1. **æ¸å˜èƒŒæ™¯**ï¼šä½¿ç”¨CSS3æ¸å˜åˆ›å»ºè§†è§‰å¸å¼•åŠ›
2. **å¡ç‰‡å¸ƒå±€**ï¼šä½¿ç”¨Gridå¸ƒå±€å®ç°å“åº”å¼å•†å“å±•ç¤º
3. **åŠ¨ç”»æ•ˆæœ**ï¼šæ·»åŠ æ·¡å…¥ã€æ»‘å…¥ç­‰åŠ¨ç”»æå‡ç”¨æˆ·ä½“éªŒ
4. **è‰²å½©æ­é…**ï¼šé‡‡ç”¨ç´«è‰²æ¸å˜ä¸»é¢˜ï¼Œç»Ÿä¸€è§†è§‰é£æ ¼

**å…³é”®CSSä»£ç ï¼š**

```css
.welcome-section {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    text-align: center;
    animation: fadeIn 0.5s ease-out;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
}

.product-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s;
    animation: fadeInUp 0.5s ease-out;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
```

## 4.2 ç”¨æˆ·ä¸å®¶åº­æ¨¡å—

### 4.2.1 ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½å®ç°

**æ³¨å†Œè§†å›¾å‡½æ•°ï¼š**

```python
def register(request):
    """ç”¨æˆ·æ³¨å†Œè§†å›¾"""
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password', '123456')
        family_name = request.POST.get('family_name')
        
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if User.objects.filter(username=username).exists():
            messages.error(request, 'ç”¨æˆ·åå·²å­˜åœ¨')
            return render(request, 'register.html')
        
        # è·å–æˆ–åˆ›å»ºå®¶åº­
        family, created = Family.objects.get_or_create(name=family_name)
        
        # åˆ›å»ºç”¨æˆ·
        user = User.objects.create_user(
            username=username,
            password=password,
            family=family
        )
        
        # å¦‚æœæ˜¯æ–°å®¶åº­ï¼Œåˆ›å»ºå®¶åº­ç”»åƒå’Œè´­ç‰©è½¦
        if created:
            FamilyProfile.objects.create(family=family)
            Cart.objects.create(family=family)
        
        messages.success(request, 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•')
        return redirect('login')
    
    return render(request, 'register.html')
```

**å®ç°è¦ç‚¹ï¼š**

1. **ç”¨æˆ·åå”¯ä¸€æ€§éªŒè¯**ï¼šæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²è¢«ä½¿ç”¨
2. **å®¶åº­è‡ªåŠ¨åˆ›å»º**ï¼šä½¿ç”¨`get_or_create`æ–¹æ³•å®ç°å®¶åº­çš„è·å–æˆ–åˆ›å»º
3. **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨Djangoçš„`create_user`æ–¹æ³•è‡ªåŠ¨åŠ å¯†å¯†ç 
4. **å…³è”æ•°æ®åˆ›å»º**ï¼šä¸ºæ–°å®¶åº­è‡ªåŠ¨åˆ›å»ºç”»åƒå’Œè´­ç‰©è½¦
5. **æ¶ˆæ¯æç¤º**ï¼šä½¿ç”¨Django messagesæ¡†æ¶æä¾›ç”¨æˆ·åé¦ˆ

### 4.2.2 ç”¨æˆ·ç™»å½•åŠŸèƒ½å®ç°

**ç™»å½•è§†å›¾å‡½æ•°ï¼š**

```python
def user_login(request):
    """ç”¨æˆ·ç™»å½•è§†å›¾"""
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        
        # éªŒè¯ç”¨æˆ·èº«ä»½
        user = authenticate(request, username=username, password=password)
        
        if user is not None:
            login(request, user)
            return redirect('home')
        else:
            messages.error(request, 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
    
    return render(request, 'login.html')
```

**ç™»å½•æ¨¡æ¿å®ç°ï¼š**

```html
<form method="post">
    {% csrf_token %}
    <div class="form-group">
        <label for="username">ç”¨æˆ·å</label>
        <input type="text" id="username" name="username" required>
    </div>
    
    <div class="form-group">
        <label for="password">å¯†ç </label>
        <input type="password" id="password" name="password" required>
    </div>
    
    <button type="submit" class="btn-login">ç™»å½•</button>
</form>
```

### 4.2.3 å®¶åº­ç”»åƒç®¡ç†å®ç°

**å®¶åº­ç”»åƒè®¾ç½®è§†å›¾ï¼š**

```python
@login_required
def update_family_profile(request):
    """æ›´æ–°å®¶åº­ç”»åƒ"""
    if request.method == 'POST':
        if not request.user.family:
            messages.error(request, 'æ‚¨è¿˜æ²¡æœ‰åŠ å…¥å®¶åº­')
            return redirect('profile')
        
        family_profile, _ = FamilyProfile.objects.get_or_create(
            family=request.user.family
        )
        
        # è·å–é€‰ä¸­çš„åˆ†ç±»
        category_ids = request.POST.getlist('categories')
        family_profile.preferred_categories.set(category_ids)
        
        messages.success(request, 'å®¶åº­ç”»åƒæ›´æ–°æˆåŠŸ')
        return redirect('profile')
    
    return redirect('profile')
```

**ç”»åƒè®¾ç½®æ¨¡æ¿ï¼š**

```html
<form method="post" action="{% url 'update_family_profile' %}">
    {% csrf_token %}
    <div class="categories-grid">
        {% for category in categories %}
        <label class="category-checkbox">
            <input type="checkbox" name="categories" value="{{ category.id }}"
                   {% if category in family_profile.preferred_categories.all %}
                   checked{% endif %}>
            <span>{{ category.name }}</span>
        </label>
        {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
</form>
```

### 4.2.4 å®¶åº­æˆå‘˜ç®¡ç†

**æ•°æ®æ¨¡å‹å…³ç³»ï¼š**

```python
class User(AbstractUser):
    """ç”¨æˆ·æ¨¡å‹"""
    family = models.ForeignKey(
        Family, 
        on_delete=models.CASCADE, 
        related_name='members',
        null=True,
        blank=True,
        verbose_name='æ‰€å±å®¶åº­'
    )
```

**å®¶åº­æˆå‘˜æŸ¥è¯¢ï¼š**

```python
# è·å–å®¶åº­æ‰€æœ‰æˆå‘˜
family_members = user.family.members.all()

# ç»Ÿè®¡å®¶åº­æˆå‘˜æ•°é‡
member_count = user.family.members.count()
```

## 4.3 ç®¡ç†å‘˜æ¨¡å—

### 4.3.1 ç®¡ç†å‘˜åå°é…ç½®

**Adminé…ç½®ï¼ˆadmin.pyï¼‰ï¼š**

```python
from django.contrib import admin
from django.utils.html import format_html

# è‡ªå®šä¹‰Adminç«™ç‚¹æ ‡é¢˜
admin.site.site_header = 'å®¶ç”¨å•†å“æ¨èç³»ç»Ÿ - ç®¡ç†åå°'
admin.site.site_title = 'ç®¡ç†åå°'
admin.site.index_title = 'æ¬¢è¿ä½¿ç”¨å®¶ç”¨å•†å“æ¨èç³»ç»Ÿç®¡ç†åå°'

@admin.register(User)
class UserAdmin(BaseUserAdmin):
    list_display = ['username', 'email', 'family', 'is_staff', 
                    'is_superuser', 'date_joined']
    list_filter = ['is_staff', 'is_superuser', 'family', 'date_joined']
    search_fields = ['username', 'email', 'family__name']
    ordering = ['-date_joined']
    list_per_page = 20
```

### 4.3.2 å•†å“ç®¡ç†å®ç°

**å•†å“Adminé…ç½®ï¼š**

```python
@admin.register(Product)
class ProductAdmin(admin.ModelAdmin):
    list_display = ['name', 'category', 'price_display', 'stock', 
                    'lifecycle', 'created_at']
    list_filter = ['category', 'created_at']
    search_fields = ['name', 'description']
    list_editable = ['stock']
    ordering = ['-created_at']
    list_per_page = 50
    
    fieldsets = (
        ('åŸºæœ¬ä¿¡æ¯', {
            'fields': ('name', 'category', 'description')
        }),
        ('ä»·æ ¼å’Œåº“å­˜', {
            'fields': ('price', 'stock')
        }),
        ('ç”Ÿå‘½å‘¨æœŸ', {
            'fields': ('lifecycle',),
            'description': 'å•†å“ä½¿ç”¨å®Œçš„é¢„è®¡å¤©æ•°ï¼Œå‰©ä½™30%æ—¶ä¼šè‡ªåŠ¨æ¨è'
        }),
    )
    
    def price_display(self, obj):
        return format_html(
            '<span style="color: #667eea; font-weight: bold;">Â¥{}</span>', 
            obj.price
        )
    price_display.short_description = 'ä»·æ ¼'
```

**å®ç°è¦ç‚¹ï¼š**

1. **åˆ—è¡¨å±•ç¤º**ï¼šé…ç½®`list_display`æ˜¾ç¤ºå…³é”®å­—æ®µ
2. **ç­›é€‰åŠŸèƒ½**ï¼šä½¿ç”¨`list_filter`å®ç°æŒ‰åˆ†ç±»å’Œæ—¶é—´ç­›é€‰
3. **æœç´¢åŠŸèƒ½**ï¼šé…ç½®`search_fields`æ”¯æŒå•†å“åç§°å’Œæè¿°æœç´¢
4. **å¿«é€Ÿç¼–è¾‘**ï¼šä½¿ç”¨`list_editable`å®ç°åˆ—è¡¨ç›´æ¥ç¼–è¾‘åº“å­˜
5. **å½©è‰²æ˜¾ç¤º**ï¼šä½¿ç”¨`format_html`å®ç°ä»·æ ¼çš„å½©è‰²æ˜¾ç¤º
6. **åˆ†ç»„å±•ç¤º**ï¼šä½¿ç”¨`fieldsets`å°†ç¼–è¾‘é¡µé¢åˆ†ç»„

### 4.3.3 è®¢å•ç®¡ç†å®ç°

**è®¢å•Adminé…ç½®ï¼š**

```python
@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = ['id', 'family', 'user', 'status_display', 
                    'total_price_display', 'created_at']
    list_filter = ['status', 'created_at']
    search_fields = ['family__name', 'user__username', 'id']
    ordering = ['-created_at']
    list_per_page = 50
    readonly_fields = ['created_at', 'updated_at']
    inlines = [OrderItemInline]
    
    def status_display(self, obj):
        status_colors = {
            'pending': '#ffa500',
            'paid': '#28a745',
            'shipped': '#17a2b8',
            'completed': '#667eea',
            'cancelled': '#dc3545',
        }
        color = status_colors.get(obj.status, '#666')
        return format_html(
            '<span style="background: {}; color: white; '
            'padding: 3px 10px; border-radius: 12px; '
            'font-weight: bold;">{}</span>',
            color, obj.get_status_display()
        )
    status_display.short_description = 'è®¢å•çŠ¶æ€'
```

**è®¢å•é¡¹å†…è”ç¼–è¾‘ï¼š**

```python
class OrderItemInline(admin.TabularInline):
    model = OrderItem
    extra = 0
    readonly_fields = ['product', 'quantity', 'price', 
                      'purchase_date', 'get_total_price']
    can_delete = False
    
    def get_total_price(self, obj):
        return f'Â¥{obj.get_total_price()}'
    get_total_price.short_description = 'å°è®¡'
```

### 4.3.4 ç”¨æˆ·è¡Œä¸ºåˆ†æå®ç°

**ç”¨æˆ·è¡Œä¸ºAdminé…ç½®ï¼š**

```python
@admin.register(UserBehavior)
class UserBehaviorAdmin(admin.ModelAdmin):
    list_display = ['user', 'product', 'behavior_type_display', 
                    'get_score_display', 'timestamp']
    list_filter = ['behavior_type', 'timestamp']
    search_fields = ['user__username', 'product__name']
    ordering = ['-timestamp']
    list_per_page = 100
    
    def behavior_type_display(self, obj):
        behavior_colors = {
            'view': '#17a2b8',
            'add_to_cart': '#ffc107',
            'purchase': '#28a745',
        }
        color = behavior_colors.get(obj.behavior_type, '#666')
        return format_html(
            '<span style="background: {}; color: white; '
            'padding: 3px 10px; border-radius: 12px; '
            'font-weight: bold;">{}</span>',
            color, obj.get_behavior_type_display()
        )
    behavior_type_display.short_description = 'è¡Œä¸ºç±»å‹'
    
    def get_score_display(self, obj):
        score = obj.get_score()
        return format_html(
            '<span style="color: #667eea; font-weight: bold; '
            'font-size: 16px;">{}</span>', 
            score
        )
    get_score_display.short_description = 'è¯„åˆ†'
```

**å®ç°è¦ç‚¹ï¼š**

1. **å½©è‰²æ ‡ç­¾**ï¼šä¸åŒè¡Œä¸ºç±»å‹ä½¿ç”¨ä¸åŒé¢œè‰²æ ‡ç­¾
2. **è¯„åˆ†æ˜¾ç¤º**ï¼šçªå‡ºæ˜¾ç¤ºè¡Œä¸ºè¯„åˆ†
3. **æ—¶é—´ç­›é€‰**ï¼šæ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ç­›é€‰è¡Œä¸ºè®°å½•
4. **ç”¨æˆ·æœç´¢**ï¼šæ”¯æŒæŒ‰ç”¨æˆ·åå’Œå•†å“åæœç´¢

### 4.3.5 æ•°æ®ç»Ÿè®¡åŠŸèƒ½

**ç»Ÿè®¡æŸ¥è¯¢ç¤ºä¾‹ï¼š**

```python
# ç”¨æˆ·ç»Ÿè®¡
total_users = User.objects.filter(is_superuser=False).count()
total_families = Family.objects.count()

# å•†å“ç»Ÿè®¡
total_products = Product.objects.count()
category_stats = Category.objects.annotate(
    product_count=Count('products')
)

# è®¢å•ç»Ÿè®¡
total_orders = Order.objects.count()
total_sales = Order.objects.filter(
    status='paid'
).aggregate(Sum('total_price'))

# ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡
behavior_stats = UserBehavior.objects.values(
    'behavior_type'
).annotate(count=Count('id'))
```

æœ¬ç« ä¸ŠåŠéƒ¨åˆ†è¯¦ç»†ä»‹ç»äº†ç³»ç»Ÿé¦–é¡µã€ç”¨æˆ·ä¸å®¶åº­æ¨¡å—ã€ç®¡ç†å‘˜æ¨¡å—çš„å®ç°ï¼ŒåŒ…æ‹¬è§†å›¾å‡½æ•°ã€æ¨¡æ¿è®¾è®¡ã€Adminé…ç½®ç­‰å…³é”®ä»£ç å’Œå®ç°è¦ç‚¹ã€‚

