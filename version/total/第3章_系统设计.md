# 第3章 系统设计

## 3.1 系统架构介绍

### 3.1.1 系统总体架构

本系统采用经典的B/S（Browser/Server）架构，基于Django框架的MVT（Model-View-Template）设计模式进行开发。系统整体架构分为三层：表现层、业务逻辑层和数据访问层。

**系统架构图：**

```
┌─────────────────────────────────────────────────────────┐
│                      表现层（前端）                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  HTML5   │  │   CSS3   │  │JavaScript│  │响应式设计 │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                            ↕ HTTP/HTTPS
┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层（Django）                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │              URL路由层（urls.py）                  │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │              视图层（views.py）                    │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    │   │
│  │  │用户管理│ │商品管理│ │购物车  │ │推荐算法│    │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘    │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │            模板层（templates/）                    │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕ ORM
┌─────────────────────────────────────────────────────────┐
│                   数据访问层（Django ORM）                │
│  ┌──────────────────────────────────────────────────┐   │
│  │              模型层（models.py）                   │   │
│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐     │   │
│  │  │User│ │Family│Product│Cart│Order│Behavior│     │   │
│  │  └────┘ └────┘ └────┘ └────┘ └────┘ └────┘     │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ↕ SQL
┌─────────────────────────────────────────────────────────┐
│                   数据存储层（SQLite）                     │
│                      db.sqlite3                          │
└─────────────────────────────────────────────────────────┘
```

### 3.1.2 系统模块划分

系统主要分为以下功能模块：

**1. 用户认证模块**
- 用户注册
- 用户登录
- 权限验证
- 会话管理

**2. 家庭管理模块**
- 家庭创建
- 家庭画像管理
- 成员管理

**3. 商品管理模块**
- 商品展示
- 商品搜索
- 商品分类
- 商品详情

**4. 购物车模块**
- 家庭共享购物车
- 商品添加/删除
- 数量修改
- 订单结算

**5. 订单管理模块**
- 订单创建
- 订单查询
- 订单状态管理

**6. 推荐系统模块**
- 用户行为追踪
- 协同过滤算法
- 推荐结果生成
- 生命周期推荐

**7. 管理员模块**
- 用户管理
- 商品管理
- 订单管理
- 数据统计

**8. 个人中心模块**
- 用户信息展示
- 订单历史
- 家庭画像设置

### 3.1.3 技术架构

**前端技术栈：**
- HTML5：页面结构
- CSS3：样式设计（渐变、动画、响应式）
- JavaScript：交互逻辑

**后端技术栈：**
- Python 3.9：编程语言
- Django 4.2：Web框架
- NumPy 2.0：科学计算

**数据库：**
- SQLite 3：关系型数据库

**开发工具：**
- VS Code：代码编辑器
- Git：版本控制
- Conda：虚拟环境管理

### 3.1.4 系统交互流程

**用户访问流程：**

1. 用户通过浏览器访问系统
2. 浏览器发送HTTP请求到Django服务器
3. Django URL路由解析请求，分发到对应的视图函数
4. 视图函数处理业务逻辑，通过ORM访问数据库
5. 数据库返回查询结果
6. 视图函数渲染模板，生成HTML页面
7. Django服务器返回HTTP响应
8. 浏览器接收并显示页面

**数据流向：**

```
用户操作 → 前端页面 → HTTP请求 → Django视图 → 
业务逻辑处理 → 数据库操作 → 返回数据 → 
模板渲染 → HTTP响应 → 前端展示
```

## 3.2 系统的主要流程设计

### 3.2.1 用户注册流程

```
开始
  ↓
用户访问注册页面
  ↓
填写注册信息（用户名、密码、家庭名称）
  ↓
提交注册表单
  ↓
系统验证用户名是否已存在
  ↓
是 → 提示用户名已存在 → 返回注册页面
  ↓ 否
检查家庭是否存在
  ↓
否 → 创建新家庭
  ↓     ↓
  ↓   创建家庭画像
  ↓     ↓
  ↓   创建购物车
  ↓     ↓
  ←─────┘
创建用户账号
  ↓
关联用户到家庭
  ↓
注册成功
  ↓
跳转到登录页面
  ↓
结束
```

**流程说明：**

1. 用户填写注册信息，包括用户名、密码和家庭名称
2. 系统首先验证用户名的唯一性
3. 检查家庭是否存在，如果不存在则创建新家庭
4. 为新家庭自动创建家庭画像和购物车
5. 创建用户账号并关联到家庭
6. 注册成功后跳转到登录页面

### 3.2.2 用户登录流程

```
开始
  ↓
用户访问登录页面
  ↓
输入用户名和密码
  ↓
提交登录表单
  ↓
系统验证用户身份
  ↓
验证失败 → 提示错误信息 → 返回登录页面
  ↓ 验证成功
创建用户会话
  ↓
判断用户类型
  ↓
管理员 → 跳转到管理后台
  ↓
普通用户 → 跳转到首页
  ↓
结束
```

### 3.2.3 商品浏览流程

```
开始
  ↓
用户访问商品列表页面
  ↓
系统加载商品数据
  ↓
用户选择筛选条件（可选）
  ├─ 按分类筛选
  ├─ 搜索商品
  └─ 排序方式
  ↓
系统根据条件过滤商品
  ↓
显示商品列表
  ↓
用户点击商品
  ↓
记录浏览行为
  ↓
显示商品详情
  ↓
用户选择操作
  ├─ 加入购物车 → 购物车流程
  ├─ 返回列表 → 商品列表
  └─ 查看推荐 → 推荐商品
  ↓
结束
```

### 3.2.4 购物车操作流程

```
开始
  ↓
用户访问购物车页面
  ↓
系统加载家庭购物车数据
  ↓
显示购物车商品列表
  ↓
用户选择操作
  ├─ 修改数量
  │   ↓
  │ 检查库存
  │   ↓
  │ 更新购物车
  │   ↓
  │ 刷新页面
  │
  ├─ 删除商品
  │   ↓
  │ 确认删除
  │   ↓
  │ 从购物车移除
  │   ↓
  │ 刷新页面
  │
  └─ 结算
      ↓
    订单结算流程
  ↓
结束
```

### 3.2.5 订单结算流程

```
开始
  ↓
用户点击结算按钮
  ↓
系统检查购物车是否为空
  ↓
为空 → 提示购物车为空 → 返回购物车
  ↓ 不为空
检查所有商品库存
  ↓
库存不足 → 提示库存不足 → 返回购物车
  ↓ 库存充足
开始事务处理
  ↓
创建订单记录
  ↓
创建订单项记录
  ↓
扣减商品库存
  ↓
记录购买行为
  ↓
清空购物车
  ↓
提交事务
  ↓
订单创建成功
  ↓
跳转到订单详情页面
  ↓
结束
```

**流程说明：**

1. 检查购物车是否为空
2. 验证所有商品的库存是否充足
3. 使用数据库事务确保数据一致性
4. 创建订单和订单项记录
5. 扣减商品库存
6. 记录用户购买行为
7. 清空购物车
8. 跳转到订单详情页面

### 3.2.6 推荐生成流程

```
开始
  ↓
用户访问首页
  ↓
系统触发推荐算法
  ↓
获取用户信息和家庭画像
  ↓
构建用户-商品评分矩阵
  ├─ 获取所有用户
  ├─ 获取所有商品
  └─ 获取用户行为数据
  ↓
计算用户相似度（余弦相似度）
  ↓
生成基于用户的推荐评分
  ↓
计算商品相似度（余弦相似度）
  ↓
生成基于商品的推荐评分
  ↓
归一化评分
  ↓
加权融合两种评分
  ↓
获取生命周期推荐商品
  ↓
提升生命周期商品评分
  ↓
排序并选取Top 10商品
  ↓
返回推荐结果
  ↓
显示在首页推荐列表
  ↓
结束
```

**推荐算法详细流程：**

1. **数据准备阶段**
   - 获取所有用户和商品
   - 构建用户-商品评分矩阵
   - 根据用户行为赋予权重（浏览=1，加购=3，购买=5）

2. **相似度计算阶段**
   - 计算用户之间的余弦相似度
   - 计算商品之间的余弦相似度

3. **评分预测阶段**
   - 基于用户相似度预测评分
   - 基于商品相似度预测评分
   - 对评分进行归一化处理

4. **结果融合阶段**
   - 加权融合两种评分（α=0.5）
   - 考虑家庭画像偏好
   - 提升生命周期商品权重

5. **推荐输出阶段**
   - 排序并选取Top 10商品
   - 过滤用户已购买商品
   - 返回推荐结果

### 3.2.7 用户行为记录流程

```
用户操作
  ↓
判断操作类型
  ├─ 浏览商品
  │   ↓
  │ 记录浏览行为（权重=1）
  │
  ├─ 加入购物车
  │   ↓
  │ 记录加购行为（权重=3）
  │
  └─ 购买商品
      ↓
    记录购买行为（权重=5）
  ↓
保存到用户行为表
  ↓
用于推荐算法计算
```

### 3.2.8 管理员操作流程

```
管理员登录
  ↓
访问管理后台
  ↓
选择管理模块
  ├─ 用户管理
  │   ├─ 查看用户列表
  │   ├─ 添加用户
  │   ├─ 编辑用户
  │   └─ 删除用户
  │
  ├─ 商品管理
  │   ├─ 查看商品列表
  │   ├─ 添加商品
  │   ├─ 编辑商品
  │   ├─ 修改库存
  │   └─ 删除商品
  │
  ├─ 订单管理
  │   ├─ 查看订单列表
  │   ├─ 查看订单详情
  │   └─ 修改订单状态
  │
  └─ 数据统计
      ├─ 用户统计
      ├─ 商品统计
      └─ 订单统计
  ↓
执行相应操作
  ↓
返回管理后台
```

## 3.3 数据库设计

### 3.3.1 数据库设计原则

1. **规范化设计**：遵循第三范式，减少数据冗余
2. **完整性约束**：使用主键、外键、唯一约束等保证数据完整性
3. **性能优化**：为常用查询字段建立索引
4. **可扩展性**：预留扩展字段，便于后续功能扩展

### 3.3.2 数据库E-R图

```
┌─────────┐         ┌─────────┐         ┌──────────────┐
│  User   │ N     1 │ Family  │ 1     1 │FamilyProfile │
│         ├─────────┤         ├─────────┤              │
│ id      │ belongs │ id      │   has   │ id           │
│username │   to    │ name    │         │ family_id    │
│password │         │created  │         │              │
│family_id│         │         │         │              │
└────┬────┘         └────┬────┘         └──────┬───────┘
     │                   │                     │
     │ 1                 │ 1                   │ N
     │                   │                     │
     │ N                 │ N                   │
     │              ┌────┴────┐         ┌──────┴───────┐
     │              │  Cart   │         │  Category    │
     │              │         │         │              │
     │              │ id      │         │ id           │
     │              │family_id│         │ name         │
     │              │         │         │              │
     │              └────┬────┘         └──────┬───────┘
     │                   │                     │
     │                   │ 1                   │ 1
     │                   │                     │
     │                   │ N                   │ N
     │              ┌────┴────────┐     ┌─────┴────────┐
     │              │  CartItem   │     │   Product    │
     │              │             │     │              │
     │              │ id          │     │ id           │
     │              │ cart_id     │     │ name         │
     │              │ product_id  │     │ category_id  │
     │              │ quantity    │     │ price        │
     │              └─────────────┘     │ stock        │
     │                                  │ lifecycle    │
     │                                  └──────┬───────┘
     │                                         │
     │ 1                                       │ 1
     │                                         │
     │ N                                       │ N
┌────┴──────────┐                      ┌──────┴───────┐
│ UserBehavior  │                      │  OrderItem   │
│               │                      │              │
│ id            │                      │ id           │
│ user_id       │                      │ order_id     │
│ product_id    │                      │ product_id   │
│ behavior_type │                      │ quantity     │
│ timestamp     │                      │ price        │
└───────────────┘                      └──────┬───────┘
                                              │
                                              │ N
                                              │
                                              │ 1
                                       ┌──────┴───────┐
                                       │    Order     │
                                       │              │
                                       │ id           │
                                       │ family_id    │
                                       │ user_id      │
                                       │ status       │
                                       │ total_price  │
                                       │ created_at   │
                                       └──────────────┘
```

### 3.3.3 数据表设计

**1. 用户表（User）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 用户ID |
| username | String(150) | Unique, Not Null | 用户名 |
| password | String(128) | Not Null | 密码（加密存储） |
| email | String(254) | Nullable | 邮箱 |
| family_id | Integer | FK, Nullable | 所属家庭ID |
| is_staff | Boolean | Default False | 是否管理员 |
| is_superuser | Boolean | Default False | 是否超级管理员 |
| date_joined | DateTime | Auto | 注册时间 |

**外键关系：**
- family_id → Family.id

**2. 家庭表（Family）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 家庭ID |
| name | String(100) | Not Null | 家庭名称 |
| created_at | DateTime | Auto | 创建时间 |

**3. 家庭画像表（FamilyProfile）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 画像ID |
| family_id | Integer | FK, Unique | 家庭ID |

**外键关系：**
- family_id → Family.id

**多对多关系：**
- preferred_categories → Category（通过中间表）

**4. 商品分类表（Category）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 分类ID |
| name | String(100) | Unique, Not Null | 分类名称 |
| description | Text | Nullable | 分类描述 |

**5. 商品表（Product）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 商品ID |
| name | String(200) | Not Null | 商品名称 |
| category_id | Integer | FK, Not Null | 分类ID |
| price | Decimal(10,2) | Not Null | 价格 |
| stock | Integer | Default 0 | 库存 |
| lifecycle | Integer | Default 30 | 生命周期（天） |
| description | Text | Nullable | 商品描述 |
| image | String(500) | Nullable | 商品图片 |
| created_at | DateTime | Auto | 创建时间 |

**外键关系：**
- category_id → Category.id

**6. 购物车表（Cart）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 购物车ID |
| family_id | Integer | FK, Unique | 家庭ID |
| created_at | DateTime | Auto | 创建时间 |
| updated_at | DateTime | Auto | 更新时间 |

**外键关系：**
- family_id → Family.id

**7. 购物车项表（CartItem）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 购物车项ID |
| cart_id | Integer | FK, Not Null | 购物车ID |
| product_id | Integer | FK, Not Null | 商品ID |
| quantity | Integer | Default 1 | 数量 |
| added_at | DateTime | Auto | 添加时间 |

**外键关系：**
- cart_id → Cart.id
- product_id → Product.id

**唯一约束：**
- (cart_id, product_id)

**8. 订单表（Order）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 订单ID |
| family_id | Integer | FK, Not Null | 家庭ID |
| user_id | Integer | FK, Nullable | 下单用户ID |
| status | String(20) | Not Null | 订单状态 |
| total_price | Decimal(10,2) | Not Null | 总价 |
| created_at | DateTime | Auto | 创建时间 |
| updated_at | DateTime | Auto | 更新时间 |

**外键关系：**
- family_id → Family.id
- user_id → User.id

**状态枚举：**
- pending：待支付
- paid：已支付
- shipped：已发货
- completed：已完成
- cancelled：已取消

**9. 订单项表（OrderItem）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 订单项ID |
| order_id | Integer | FK, Not Null | 订单ID |
| product_id | Integer | FK, Not Null | 商品ID |
| quantity | Integer | Not Null | 数量 |
| price | Decimal(10,2) | Not Null | 单价 |
| purchase_date | DateTime | Auto | 购买时间 |

**外键关系：**
- order_id → Order.id
- product_id → Product.id

**10. 用户行为表（UserBehavior）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | Integer | PK, Auto | 行为ID |
| user_id | Integer | FK, Not Null | 用户ID |
| product_id | Integer | FK, Not Null | 商品ID |
| behavior_type | String(20) | Not Null | 行为类型 |
| timestamp | DateTime | Auto | 时间戳 |

**外键关系：**
- user_id → User.id
- product_id → Product.id

**行为类型枚举：**
- view：浏览（权重=1）
- add_to_cart：加入购物车（权重=3）
- purchase：购买（权重=5）

### 3.3.4 索引设计

为提高查询性能，对以下字段建立索引：

1. **User表**
   - username（唯一索引）
   - family_id（普通索引）

2. **Product表**
   - category_id（普通索引）
   - created_at（普通索引）

3. **Order表**
   - family_id（普通索引）
   - user_id（普通索引）
   - status（普通索引）
   - created_at（普通索引）

4. **UserBehavior表**
   - user_id（普通索引）
   - product_id（普通索引）
   - behavior_type（普通索引）
   - timestamp（普通索引）

### 3.3.5 数据库关系说明

**一对一关系：**
- Family ↔ FamilyProfile（一个家庭对应一个画像）
- Family ↔ Cart（一个家庭对应一个购物车）

**一对多关系：**
- Family → User（一个家庭有多个用户）
- Family → Order（一个家庭有多个订单）
- Category → Product（一个分类有多个商品）
- Cart → CartItem（一个购物车有多个商品项）
- Order → OrderItem（一个订单有多个商品项）
- User → UserBehavior（一个用户有多个行为记录）
- Product → UserBehavior（一个商品有多个行为记录）

**多对多关系：**
- FamilyProfile ↔ Category（家庭画像与分类的多对多关系）

本章详细介绍了系统的整体架构、主要业务流程和数据库设计，为系统实现提供了完整的设计方案和技术蓝图。

